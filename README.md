# Introduction

This GitHub provide an example how to generate reports related to your App Registration in Azure Active Directory.  When your applications stacks growth in Azure Active Directory it can be difficult to keep track (inventory) of what you have there with the permissions of those applications.

This GitHub propose one solution (proof of concept) that you can leverage using Serverless technologies.  The goal was to writte the less code possible, to do so, Logic App where used here.

The list of reports generated by this PoC are the following:

<ul>
    <li>Applications registration with their owners</li>
    <li>Applications registration with less than two owners</li>
    <li>Applications registration with credentials that will expired in the next 3 months</li>
    <li>Applications registration with their permission</li>
</ul>

**Important**, the logic app use the built-in connector for **CosmosDB** that is currently in **preview**.  This connector was used for better DevOps and this PoC come **"AS IS"** without any **warranty**.  If you create the same concept for production workload and the connector is still in preview is recommended to use the **Azure managed connector**.

# Architecture

![Architecture](https://github.com/hugogirard/appRegistrationGovernance/blob/main/diagram/logicapp.drawio.png?raw=true)

The architecture diagram is quite simple, all the logic is encapsulated inside the Logic App (two workflows).  CosmosDB is used to manipulate the data and save the results.  From there, we generate a report in **CSV** file and save it into an Azure Storage.  Because all data are saved in CosmosDB it will be easy after to use Power BI to generate a more user friendly report (or any other report tool).  THis example provides only a simple CSV file for report purpose.

# Prerequisites

First step is to Fork this repository.

Next you will need to create a service principal to run the GitHub action.  This service principal need to have **contributor** right on the subscription you will install the Azure resources.  To do this, follow this [link](https://github.com/marketplace/actions/azure-login#configure-a-service-principal-with-a-secret). Be sure to take note of the credential returned when creating the **service principal** you will need it for the next step.

Now create an application registration, this will be used to query **MSGraph** to extract the information from your **Azure Active Directory**.

The application needs the API permissions called **Directory.Read.All** from application permissions. Take note of the **Application (client) id** and create a new secrets for this application, both information will be needed for the logic app.

# Create GitHub secrets

Now create the following [GitHub actions secrets](https://docs.github.com/en/rest/actions/secrets?apiVersion=2022-11-28).

| Name | Value
| ----- | -----
| AZURE_CREDENTIALS | The value from the step before when creating the service principal.
| SUBSCRIPTION_ID | The ID of the subscription where all the resources will be created.
| CLIENT_ID | The client ID associated to the created application.
| CLIENT_SECRET | The secret created from the application.
| PA_TOKEN | A personnal access token needed to write secret, to know the proper permission to give follow this [link](https://github.com/marketplace/actions/create-github-secret-action).

# Create the Azure resources

Now, execute the GitHub action called **Create Azure Resources**, this will create all necessary resources in Azure in a resource group called **rg-logic-app-governance**.  Once the GitHub action finished, now you can run the one called **Deploy Logic App**.